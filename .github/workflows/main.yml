# Tên của workflow (hiển thị trên tab Actions)
name: Build Xamarin App

# Định nghĩa sự kiện kích hoạt workflow
# Ví dụ: Chạy mỗi khi có push lên nhánh 'main'
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Định nghĩa các công việc (jobs) sẽ chạy
jobs:
  # --- Công việc build cho Android ---
  build_android:
    # Chọn hệ điều hành cho máy ảo chạy job này
    runs-on: windows-latest # Hoặc ubuntu-latest

    steps:
      # Bước 1: Checkout code từ repository về máy ảo
      - name: Checkout code
        uses: actions/checkout@v4 # Sử dụng action có sẵn của GitHub

      # Bước 2: Cài đặt Java (cần cho Android SDK)
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft' # Hoặc 'temurin', 'zulu', etc.
          java-version: '11' # Chọn phiên bản JDK phù hợp với dự án Xamarin của bạn

      # Bước 3: Cài đặt .NET SDK (Nếu cần phiên bản cụ thể, nếu không máy ảo thường có sẵn)
      # - name: Setup .NET SDK
      #   uses: actions/setup-dotnet@v4
      #   with:
      #     dotnet-version: '6.0.x' # Thay bằng phiên bản .NET bạn cần
      
      # *** BƯỚC THÊM VÀO: Thiết lập MSBuild ***
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2 # Kiểm tra phiên bản mới nhất nếu cần

      # Bước 4: Khôi phục các gói NuGet (Đảm bảo đúng tên file .sln)
      - name: Restore NuGet packages
        run: nuget restore "WoWonder.sln" # Giả sử đây là file solution gốc của bạn

      # Debugging step: List directory structure
      - name: List directory structure
        run: |
          echo "Listing root directory:"
          ls "${{ github.workspace }}"
          if [ -d "${{ github.workspace }}/Script" ]; then
            echo "Listing Script directory:"
            ls "${{ github.workspace }}/Script"
          else
            echo "Script directory does not exist."
          fi
          if [ -d "${{ github.workspace }}/WoWonder" ]; then
            echo "Listing WoWonder directory:"
            ls "${{ github.workspace }}/WoWonder"
          else
            echo "WoWonder directory does not exist."
          fi

      # Debugging step: List all files recursively to locate WoWonder.csproj
      - name: Locate WoWonder.csproj
        run: |
          echo "Listing all files recursively to locate WoWonder.csproj:"
          find "${{ github.workspace }}" -type f -name "WoWonder.csproj" || echo "WoWonder.csproj not found."

      # Bước 5: Build dự án Android
      - name: Build Android project
        if: ${{ env.WOWONDER_PROJECT_EXISTS == 'true' }}
        run: |
          if [ -f "${{ github.workspace }}/WoWonder/WoWonder.csproj" ]; then
            msbuild /p:Configuration=Release /t:PackageForAndroid "${{ github.workspace }}/WoWonder/WoWonder.csproj"
          else
            echo "WoWonder.csproj not found. Skipping build."
          fi

      # Bước 6: Upload Artifact (Đảm bảo path khớp với output của target đã chọn)
      - name: Upload Android Artifact
        if: ${{ env.WOWONDER_PROJECT_EXISTS == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: WoWonder/bin/Release/*.apk || echo "No APK found to upload."

